<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Investment Financial Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #6C3F49;
            --color-primary-dark: #5A323B;
            --color-secondary: #4A7B9D;
            --color-accent: #34A853;
            --color-warning: #FBBC05;
            --color-danger: #EA4335;
            --color-surface: #FBF9F8;
            --color-surface-alt: #E2E0DF;
            --color-page-bg: #CCBEBF;
            --color-border: #E0D8D8;
            --color-text-default: #0F1E35;
            --color-text-muted: #46505A;
            --color-text-on-primary: #FFFFFF;
            --radius-md: 12px;
            --shadow-card: 0 2px 6px rgba(17, 24, 39, 0.08);
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-xxl: 48px;
            --font-family: 'Inter', system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-family-arabic: 'Cairo', 'Tahoma', sans-serif;
        }

        [data-theme="dark"] {
            --color-primary: #8C5F69;
            --color-primary-dark: #744A54;
            --color-secondary: #5D99C2;
            --color-surface: #2A2A2A;
            --color-surface-alt: #3A3A3A;
            --color-page-bg: #1A1A1A;
            --color-border: #444444;
            --color-text-default: #FFFFFF;
            --color-text-muted: #BBBBBB;
            --color-text-on-primary: #FFFFFF;
        }

        [dir="rtl"] {
            text-align: right;
            font-family: var(--font-family-arabic);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--color-page-bg);
            color: var(--color-text-default);
            line-height: 1.6;
            padding-bottom: 60px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: "";
            position: fixed;
            bottom: -100px;
            right: -100px;
            width: 300px;
            height: 300px;
            background-image: radial-gradient(circle, rgba(108, 63, 73, 0.1) 10%, transparent 10%);
            background-size: 20px 20px;
            opacity: 0.2;
            z-index: -1;
        }

        .app-bar {
            background-color: var(--color-primary);
            color: var(--color-text-on-primary);
            height: auto;
            min-height: 56px;
            padding: var(--spacing-sm) var(--spacing-md);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            gap: var(--spacing-sm);
        }

        .app-bar-title-container {
            display: flex;
            flex-direction: column;
        }

        .app-bar-title {
            font-weight: 600;
            font-size: 1.25rem;
        }

        .app-bar-subtitle {
            font-size: 0.75rem;
            opacity: 0.85;
            font-weight: 400;
        }

        .app-bar-controls {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .app-bar-btn {
            background-color: var(--color-primary-dark);
            color: var(--color-text-on-primary);
            border: none;
            border-radius: var(--radius-md);
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
            white-space: nowrap;
        }

        .app-bar-btn:hover {
            background-color: rgba(0, 0, 0, 0.2);
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: var(--color-surface);
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .dropdown-content button {
            color: var(--color-text-default);
            padding: var(--spacing-sm) var(--spacing-md);
            text-decoration: none;
            display: block;
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
        }

        .dropdown-content button:hover {
            background-color: var(--color-surface-alt);
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .hero-strip {
            height: 24px;
            background-color: var(--color-primary);
            margin-bottom: var(--spacing-lg);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--spacing-lg);
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--spacing-lg);
        }

        .card {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-card);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .card-header {
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }

        .card-title {
            font-size: 1.0625rem;
            font-weight: 600;
            color: var(--color-primary);
        }

        .card-subtitle {
            font-size: 0.8125rem;
            color: var(--color-text-muted);
        }

        .card-actions {
            display: flex;
            gap: var(--spacing-xs);
        }

        .form-group {
            margin-bottom: var(--spacing-md);
        }

        label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
        }

        input, select, button, textarea {
            font-family: inherit;
        }

        input[type="number"], input[type="date"], input[type="text"], select, textarea {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            background-color: var(--color-surface);
            color: var(--color-text-default);
        }

        input:invalid {
            border-color: var(--color-danger);
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .slider {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            background: var(--color-surface-alt);
            border-radius: 3px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
        }

        .slider-value {
            min-width: 50px;
            text-align: center;
            font-weight: 600;
        }

        .btn {
            padding: var(--spacing-sm) var(--spacing-md);
            background-color: var(--color-primary);
            color: var(--color-text-on-primary);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
        }

        .btn:hover {
            background-color: #5F3640;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: var(--color-secondary);
        }

        .btn-secondary:hover {
            background-color: #3B6A8C;
        }

        .btn-accent {
            background-color: var(--color-accent);
        }

        .btn-accent:hover {
            background-color: #2C8845;
        }

        .btn-warning {
            background-color: var(--color-warning);
            color: var(--color-text-default);
        }

        .btn-warning:hover {
            background-color: #E2A704;
        }

        .btn-danger {
            background-color: var(--color-danger);
        }

        .btn-danger:hover {
            background-color: #D33426;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--color-primary);
            color: var(--color-primary);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-outline:hover {
            background-color: rgba(108, 63, 73, 0.1);
            transform: translateY(-1px);
        }

        .btn-sm {
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 0.875rem;
        }

        .btn-icon {
            padding: var(--spacing-xs);
        }

        .toggle-container {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .toggle-btn {
            flex: 1;
            text-align: center;
            padding: var(--spacing-sm);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            background-color: var(--color-surface-alt);
            transition: all 0.2s;
        }

        .toggle-btn.active {
            background-color: var(--color-primary);
            color: var(--color-text-on-primary);
        }

        .result-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .result-item {
            text-align: center;
            padding: var(--spacing-md);
            background-color: var(--color-surface-alt);
            border-radius: var(--radius-md);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .result-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: var(--spacing-xs);
        }

        .result-label {
            font-size: 0.8125rem;
            color: var(--color-text-muted);
        }

        .transaction-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--color-border);
            align-items: center;
            gap: var(--spacing-sm);
        }

        .transaction-details {
            flex: 1;
        }

        .transaction-date {
            color: var(--color-text-muted);
            font-size: 0.875rem;
        }

        .transaction-amount {
            font-weight: 600;
        }

        .transaction-actions {
            display: flex;
            gap: var(--spacing-xs);
        }

        .positive {
            color: var(--color-accent);
        }

        .negative {
            color: var(--color-danger);
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
        }

        .tab {
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab.active {
            border-bottom: 2px solid var(--color-primary);
            color: var(--color-primary);
            font-weight: 500;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .chart-container {
            height: 300px;
            margin-bottom: var(--spacing-lg);
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .chart-card {
            background-color: var(--color-surface);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-card);
        }

        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: var(--spacing-md);
            text-align: center;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }

        .load-more {
            text-align: center;
            margin-top: var(--spacing-md);
        }

        .advice-section {
            background-color: var(--color-surface-alt);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
        }

        .advice-title {
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--color-primary);
        }

        .advice-list {
            padding-left: var(--spacing-lg);
        }

        .advice-item {
            margin-bottom: var(--spacing-sm);
        }

        .investment-item {
            background-color: var(--color-surface-alt);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
            position: relative;
        }

        .investment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .investment-title {
            font-weight: 600;
            color: var(--color-primary);
        }

        .investment-actions {
            display: flex;
            gap: var(--spacing-xs);
        }

        .investment-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .metric-item {
            text-align: center;
            padding: var(--spacing-md);
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            color: white;
            border-radius: var(--radius-md);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: var(--spacing-xs);
        }

        .metric-label {
            font-size: 0.8125rem;
            opacity: 0.9;
        }

        .performance-badge {
            display: inline-block;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .performance-positive {
            background-color: rgba(52, 168, 83, 0.2);
            color: var(--color-accent);
        }

        .performance-negative {
            background-color: rgba(234, 67, 53, 0.2);
            color: var(--color-danger);
        }

        /* Portfolio Investment Cards */
        .portfolio-card {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            box-shadow: var(--shadow-card);
            transition: all 0.3s ease;
        }

        .portfolio-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .portfolio-card-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--color-primary);
        }

        .portfolio-card-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
        }

        .portfolio-card-detail {
            font-size: 0.875rem;
        }

        .portfolio-card-detail-label {
            color: var(--color-text-muted);
            font-weight: 500;
        }

        .portfolio-card-detail-value {
            font-weight: 600;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--color-surface);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--color-border);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--color-primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--color-text-muted);
        }

        /* Responsive styles */
        @media (min-width: 768px) {
            .grid {
                grid-template-columns: 2fr 1fr;
            }
            
            .investment-form {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }

        @media (max-width: 1200px) {
            .result-summary {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 992px) {
            .app-bar {
                flex-direction: row;
                align-items: center;
                padding: var(--spacing-sm);
            }
            
            .app-bar-controls {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .container {
                padding: 0 var(--spacing-md);
            }
        }

        @media (max-width: 767px) {
            .container {
                padding: 0 var(--spacing-sm);
            }
            
            .grid {
                gap: 16px;
            }
            
            .result-summary {
                grid-template-columns: 1fr;
            }
            
            .card {
                padding: var(--spacing-md);
            }
            
            .app-bar-title {
                font-size: 1.1rem;
            }
            
            .app-bar-btn {
                padding: var(--spacing-xs) var(--spacing-sm);
                font-size: 0.9rem;
            }
            
            .transaction-item {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--spacing-xs);
            }
            
            .transaction-actions {
                align-self: flex-end;
            }
            
            .investment-form {
                grid-template-columns: 1fr;
            }
            
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .portfolio-card-details {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 480px) {
            .app-bar-controls {
                flex-direction: column;
                width: 100%;
            }
            
            .app-bar-btn {
                width: 100%;
                margin-bottom: var(--spacing-xs);
            }
            
            .dropdown {
                width: 100%;
            }
            
            .dropdown-content {
                width: 100%;
                right: auto;
                left: 0;
            }
            
            .toggle-container {
                flex-direction: column;
            }
            
            .result-summary {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                text-align: center;
                padding: var(--spacing-xs) var(--spacing-sm);
            }
            
            .metric-grid {
                grid-template-columns: 1fr;
            }
            
            .portfolio-card-details {
                grid-template-columns: 1fr;
            }
        }

        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(40px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div class="app-bar">
        <div class="app-bar-title-container">
            <div class="app-bar-title" data-translate="appTitle">Personal Investment Financial Calculator</div>
            <div class="app-bar-subtitle" data-translate="appSubtitle">by RedJuice</div>
        </div>
        <div class="app-bar-controls">
            <button id="theme-toggle" class="app-bar-btn">üåô <span data-translate="darkMode">Dark Mode</span></button>
            <button id="language-toggle" class="app-bar-btn">ÿπÿ±ÿ®Ÿâ</button>
            <div class="dropdown">
                <button class="app-bar-btn">‚ùì How To</button>
                <div class="dropdown-content">
                    <button id="show-guide">User Guide & Benefits</button>
                </div>
            </div>
            <div class="dropdown">
                <button class="app-bar-btn">üíæ <span data-translate="dataManagement">Data Management</span></button>
                <div class="dropdown-content">
                    <button id="save-data" data-translate="saveData">Save Data</button>
                    <button id="load-data" data-translate="loadData">Load Data</button>
                    <button id="export-data" data-translate="exportData">Export to JSON</button>
                    <button id="import-data" data-translate="importData">Import from JSON</button>
                </div>
            </div>
        </div>
    </div>

    <div class="hero-strip"></div>

    <div class="container">
        <div class="grid">
            <div class="main-content">
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title" data-translate="investmentParameters">Portfolio Investments</div>
                            <div class="card-subtitle" data-translate="enterInvestmentDetails">Manage your investment portfolio</div>
                        </div>
                        <div class="card-actions">
                            <button id="add-investment" class="btn btn-accent btn-sm">+ <span>Add Investment</span></button>
                        </div>
                    </div>
                    
                    <div id="investment-form-container" style="display: none;">
                        <div class="investment-form">
                            <div class="form-group">
                                <label>Investment Name</label>
                                <input type="text" id="investment-name" placeholder="e.g., Retirement Fund">
                            </div>
                            <div class="form-group">
                                <label>Initial Amount ($)</label>
                                <input type="number" id="investment-amount" min="0" value="10000" step="100">
                            </div>
                            <div class="form-group">
                                <label>Interest Rate (%)</label>
                                <div class="slider-container">
                                    <input type="range" id="investment-rate" min="0" max="50" step="0.1" value="7">
                                    <span class="slider-value">7%</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Calculation Frequency</label>
                                <select id="investment-frequency">
                                    <option value="monthly">Monthly Compounding</option>
                                    <option value="quarterly">Quarterly Compounding</option>
                                    <option value="annually">Annual Compounding</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Monthly Contribution ($)</label>
                                <input type="number" id="investment-monthly" min="0" value="100" step="10">
                            </div>
                            <div class="form-group">
                                <label>Investment Period (Years)</label>
                                <input type="number" id="investment-period" min="1" max="50" value="10">
                            </div>
                            <div class="form-group">
                                <label>Start Date</label>
                                <input type="date" id="investment-date">
                            </div>
                        </div>
                        <div class="card-actions">
                            <button id="save-investment" class="btn btn-accent">Save Investment</button>
                            <button id="cancel-investment" class="btn btn-outline">Cancel</button>
                        </div>
                    </div>
                    
                    <div id="portfolio-container">
                        <!-- Portfolio investment cards will be added here -->
                        <div class="portfolio-card slide-up">
                            <div class="portfolio-card-header">
                                <div class="portfolio-card-title">Sample Investment</div>
                                <div class="investment-actions">
                                    <button class="btn btn-danger btn-sm btn-icon">√ó</button>
                                </div>
                            </div>
                            <div class="portfolio-card-details">
                                <div class="portfolio-card-detail">
                                    <div class="portfolio-card-detail-label">Amount</div>
                                    <div class="portfolio-card-detail-value">$10,000</div>
                                </div>
                                <div class="portfolio-card-detail">
                                    <div class="portfolio-card-detail-label">Rate</div>
                                    <div class="portfolio-card-detail-value">7%</div>
                                </div>
                                <div class="portfolio-card-detail">
                                    <div class="portfolio-card-detail-label">Start Date</div>
                                    <div class="portfolio-card-detail-value">Jan 1, 2023</div>
                                </div>
                                <div class="portfolio-card-detail">
                                    <div class="portfolio-card-detail-label">Period</div>
                                    <div class="portfolio-card-detail-value">10 years</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button id="calculate-btn" class="btn" style="margin-top: var(--spacing-md);"><span data-translate="calculate">Calculate Portfolio</span></button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title" data-translate="additionalTransactions">Portfolio Transactions</div>
                            <div class="card-subtitle" data-translate="addOneTimeTransactions">Add deposits or withdrawals to your portfolio</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="transaction-date" data-translate="transactionDate">Transaction Date</label>
                        <input type="date" id="transaction-date">
                    </div>
                    
                    <div class="form-group">
                        <label for="transaction-amount" data-translate="amount">Amount ($)</label>
                        <input type="number" id="transaction-amount" step="10" placeholder="Enter amount">
                    </div>
                    
                    <div class="form-group">
                        <label for="transaction-type" data-translate="transactionType">Transaction Type</label>
                        <select id="transaction-type">
                            <option value="deposit" data-translate="deposit">Deposit</option>
                            <option value="withdrawal" data-translate="withdrawal">Withdrawal</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="investment-select">Apply to Investment</label>
                        <select id="investment-select">
                            <option value="all">Entire Portfolio</option>
                            <!-- Investment options will be populated here -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="recurring-months" data-translate="recurringMonths">Recurring (0 for one-time)</label>
                        <input type="number" id="recurring-months" min="0" value="0">
                    </div>
                    
                    <button id="add-transaction" class="btn"><span data-translate="addTransaction">Add Transaction</span></button>
                    
                    <div class="transaction-list" id="transactions-container" style="margin-top: var(--spacing-md);">
                        <!-- Transactions will be added here -->
                        <div class="transaction-item">
                            <div class="transaction-details">
                                <div class="transaction-date">Jan 15, 2023</div>
                                <div>One-time deposit to Entire Portfolio</div>
                            </div>
                            <div class="transaction-amount positive">+$500.00</div>
                            <div class="transaction-actions">
                                <button class="btn-outline btn-sm">Remove</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="tabs">
                        <div class="tab active" data-tab="summary"><span data-translate="summary">Summary</span></div>
                        <div class="tab" data-tab="detailed"><span data-translate="detailedBreakdown">Detailed Breakdown</span></div>
                        <div class="tab" data-tab="advice"><span data-translate="investmentAdvice">Investment Advice</span></div>
                        <div class="tab" data-tab="dashboard"><span data-translate="dashboard">Dashboard</span></div>
                    </div>
                    
                    <div class="tab-content active" id="summary-tab">
                        <div class="metric-grid">
                            <div class="metric-item">
                                <div class="metric-value" id="final-amount">$0</div>
                                <div class="metric-label" data-translate="finalAmount">Final Amount</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value" id="total-interest">$0</div>
                                <div class="metric-label" data-translate="totalInterest">Total Interest</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value" id="total-contributions">$0</div>
                                <div class="metric-label" data-translate="totalContributions">Total Contributions</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value" id="roi">0%</div>
                                <div class="metric-label" data-translate="roi">ROI</div>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <canvas id="summary-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="detailed-tab">
                        <div class="transaction-list" id="breakdown-container">
                            <!-- Detailed breakdown will be added here -->
                        </div>
                        <div class="load-more">
                            <button id="load-more" class="btn"><span data-translate="loadMore">Load More</span> (50 <span data-translate="records">records</span>)</button>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="advice-tab">
                        <div class="advice-section">
                            <div class="advice-title" data-translate="portfolioDiversification">Portfolio Diversification</div>
                            <ul class="advice-list">
                                <li class="advice-item" data-translate="diversificationTip1">Consider allocating across different asset classes (stocks, bonds, real estate)</li>
                                <li class="advice-item" data-translate="diversificationTip2">US Market: Focus on S&P 500 index funds for broad market exposure</li>
                                <li class="advice-item" data-translate="diversificationTip3">Saudi Market: Consider Tadawul All Share Index (TASI) ETFs</li>
                                <li class="advice-item" data-translate="diversificationTip4">Egypt Market: EGX 30 index provides exposure to top Egyptian companies</li>
                                <li class="advice-item" data-translate="diversificationTip5">Rebalance portfolio annually to maintain target allocations</li>
                            </ul>
                        </div>
                        
                        <div class="advice-section">
                            <div class="advice-title" data-translate="suggestedAllocation">Suggested Allocation</div>
                            <div class="chart-container">
                                <canvas id="allocation-chart"></canvas>
                            </div>
                        </div>

                        <div class="advice-section">
                            <div class="advice-title" data-translate="investmentProjection">Investment Projection & Forecasting</div>
                            <div class="chart-container">
                                <canvas id="projection-chart"></canvas>
                            </div>
                            <p class="card-subtitle" data-translate="projectionSubtitle">Based on historical market performance and your selected parameters</p>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="dashboard-tab">
                        <div class="chart-grid">
                            <div class="chart-card">
                                <div class="chart-title" data-translate="portfolioGrowth">Portfolio Growth Over Time</div>
                                <div class="chart-container">
                                    <canvas id="growth-chart"></canvas>
                                </div>
                            </div>
                            <div class="chart-card">
                                <div class="chart-title" data-translate="annualReturns">Annual Returns</div>
                                <div class="chart-container">
                                    <canvas id="returns-chart"></canvas>
                                </div>
                            </div>
                            <div class="chart-card">
                                <div class="chart-title" data-translate="incomeSources">Income Sources</div>
                                <div class="chart-container">
                                    <canvas id="income-chart"></canvas>
                                </div>
                            </div>
                            <div class="chart-card">
                                <div class="chart-title" data-translate="riskAnalysis">Risk Analysis</div>
                                <div class="chart-container">
                                    <canvas id="risk-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar">
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title" data-translate="recentCalculations">Recent Calculations</div>
                            <div class="card-subtitle" data-translate="yourInvestmentActivity">Your investment activity</div>
                        </div>
                    </div>
                    <div class="transaction-list" id="recent-transactions">
                        <!-- Recent transactions will be added here -->
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title" data-translate="portfolioPerformance">Portfolio Performance</div>
                            <div class="card-subtitle" data-translate="historicalGrowthSimulation">Historical growth simulation</div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="performance-chart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title" data-translate="quickMetrics">Quick Metrics</div>
                            <div class="card-subtitle" data-translate="keyPerformanceIndicators">Key performance indicators</div>
                        </div>
                    </div>
                    <div class="result-summary">
                        <div class="result-item">
                            <div class="result-value" id="avg-return">0%</div>
                            <div class="result-label" data-translate="avgAnnualReturn">Avg. Annual Return</div>
                        </div>
                        <div class="result-item">
                            <div class="result-value" id="best-year">0%</div>
                            <div class="result-label" data-translate="bestYear">Best Year</div>
                        </div>
                        <div class="result-item">
                            <div class="result-value" id="worst-year">0%</div>
                            <div class="result-label" data-translate="worstYear">Worst Year</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- How To Guide Modal -->
    <div id="guide-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Investment Calculator Guide</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <h3>Benefits of Using This Calculator</h3>
                <ul>
                    <li>Plan and visualize your financial future with accurate projections</li>
                    <li>Compare different investment scenarios and strategies</li>
                    <li>Understand the power of compound interest over time</li>
                    <li>Optimize your portfolio allocation for better returns</li>
                    <li>Track additional transactions and their impact on your portfolio</li>
                </ul>
                
                <h3>How to Use This Calculator</h3>
                <ol>
                    <li><strong>Add Investments:</strong> Click "Add Investment" to create a new portfolio item. Fill in the details and click "Save Investment".</li>
                    <li><strong>Manage Portfolio:</strong> Each investment appears as a card that you can delete if needed.</li>
                    <li><strong>Add Transactions:</strong> Use the Transactions section to add deposits or withdrawals to specific investments or your entire portfolio.</li>
                    <li><strong>Calculate:</strong> Click "Calculate Portfolio" to see projections and analysis.</li>
                    <li><strong>Review Results:</strong> Explore the different tabs (Summary, Detailed Breakdown, Advice, Dashboard) to understand your portfolio's potential.</li>
                    <li><strong>Save/Load Data:</strong> Use the Data Management menu to save your progress or load previous calculations.</li>
                </ol>
                
                <h3>Tips for Better Results</h3>
                <ul>
                    <li>Be realistic with your expected rate of return</li>
                    <li>Consider inflation when estimating future values</li>
                    <li>Regular contributions significantly impact long-term growth</li>
                    <li>Diversify your portfolio across different asset classes</li>
                    <li>Review and adjust your investments annually</li>
                </ul>
            </div>
        </div>
    </div>

    <input type="file" id="import-file" style="display: none;" accept=".json">

    <script>
        // Initialize variables
        let currentTheme = 'light';
        let currentLanguage = 'en';
        let breakdownData = [];
        let displayCount = 50;
        let transactions = [];
        let investments = [];
        let db = null;
        let recentCalculations = [];
        
        // Translation dictionary
        const translations = {
            en: {
                appTitle: "Personal Investment Financial Calculator",
                appSubtitle: "by RedJuice",
                darkMode: "Dark Mode",
                dataManagement: "Data Management",
                saveData: "Save Data",
                loadData: "Load Data",
                exportData: "Export to JSON",
                importData: "Import from JSON",
                investmentParameters: "Investment Parameters",
                enterInvestmentDetails: "Enter your investment details",
                addInvestment: "Add Investment",
                calculate: "Calculate",
                additionalTransactions: "Additional Transactions",
                addOneTimeTransactions: "Add one-time deposits or withdrawals",
                transactionDate: "Transaction Date",
                amount: "Amount ($)",
                transactionType: "Transaction Type",
                deposit: "Deposit",
                withdrawal: "Withdrawal",
                recurringMonths: "Recurring (0 for one-time)",
                addTransaction: "Add Transaction",
                recalculateWithTransactions: "Recalculate with Transactions",
                summary: "Summary",
                detailedBreakdown: "Detailed Breakdown",
                investmentAdvice: "Investment Advice",
                dashboard: "Dashboard",
                finalAmount: "Final Amount",
                totalInterest: "Total Interest",
                totalContributions: "Total Contributions",
                roi: "ROI",
                loadMore: "Load More",
                records: "records",
                portfolioDiversification: "Portfolio Diversification",
                diversificationTip1: "Consider allocating across different asset classes (stocks, bonds, real estate)",
                diversificationTip2: "US Market: Focus on S&P 500 index funds for broad market exposure",
                diversificationTip3: "Saudi Market: Consider Tadawul All Share Index (TASI) ETFs",
                diversificationTip4: "Egypt Market: EGX 30 index provides exposure to top Egyptian companies",
                diversificationTip5: "Rebalance portfolio annually to maintain target allocations",
                suggestedAllocation: "Suggested Allocation",
                investmentProjection: "Investment Projection & Forecasting",
                projectionSubtitle: "Based on historical market performance and your selected parameters",
                portfolioGrowth: "Portfolio Growth Over Time",
                annualReturns: "Annual Returns",
                incomeSources: "Income Sources",
                riskAnalysis: "Risk Analysis",
                recentCalculations: "Recent Calculations",
                yourInvestmentActivity: "Your investment activity",
                portfolioPerformance: "Portfolio Performance",
                historicalGrowthSimulation: "Historical growth simulation",
                quickMetrics: "Quick Metrics",
                keyPerformanceIndicators: "Key performance indicators",
                avgAnnualReturn: "Avg. Annual Return",
                bestYear: "Best Year",
                worstYear: "Worst Year",
                investmentTitle: "Investment Title",
                initialInvestment: "Initial Investment ($)",
                interestRate: "Interest Rate (%)",
                calculationFrequency: "Calculation Frequency",
                monthlyAdd: "Monthly Add-on ($)",
                investmentPeriod: "Investment Period",
                years: "Years",
                months: "Months",
                days: "Days",
                periodValue: "Period Value",
                startDate: "Start Date",
                remove: "Remove"
            },
            ar: {
                appTitle: "ÿ≠ÿßÿ≥ÿ®ÿ© ÿßŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ± ÿßŸÑŸÖÿßŸÑŸä ÿßŸÑÿ¥ÿÆÿµŸäÿ©",
                appSubtitle: "ÿ®Ÿàÿßÿ≥ÿ∑ÿ© RedJuice",
                darkMode: "ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÑŸäŸÑŸä",
                dataManagement: "ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™",
                saveData: "ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™",
                loadData: "ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™",
                exportData: "ÿ™ÿµÿØŸäÿ± ÿ•ŸÑŸâ JSON",
                importData: "ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ŸÖŸÜ JSON",
                investmentParameters: "ŸÖÿπÿßŸÖŸÑÿßÿ™ ÿßŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±",
                enterInvestmentDetails: "ÿ£ÿØÿÆŸÑ ÿ™ŸÅÿßÿµŸäŸÑ ÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±ŸÉ",
                addInvestment: "ÿ•ÿ∂ÿßŸÅÿ© ÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±",
                calculate: "ÿ≠ÿ≥ÿßÿ®",
                additionalTransactions: "ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅŸäÿ©",
                addOneTimeTransactions: "ÿ•ÿ∂ÿßŸÅÿ© ŸàÿØÿßÿ¶ÿπ ÿ£Ÿà ÿ≥ÿ≠Ÿàÿ®ÿßÿ™ ŸÑŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ©",
                transactionDate: "ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖÿπÿßŸÖŸÑÿ©",
                amount: "ÿßŸÑŸÖÿ®ŸÑÿ∫ ($)",
                transactionType: "ŸÜŸàÿπ ÿßŸÑŸÖÿπÿßŸÖŸÑÿ©",
                deposit: "ÿ•ŸäÿØÿßÿπ",
                withdrawal: "ÿ≥ÿ≠ÿ®",
                recurringMonths: "ŸÖÿ™ŸÉÿ±ÿ± (0 ŸÑŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ©)",
                addTransaction: "ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿπÿßŸÖŸÑÿ©",
                recalculateWithTransactions: "ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸÖÿπ ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™",
                summary: "ŸÖŸÑÿÆÿµ",
                detailedBreakdown: "ÿ™ŸÅÿµŸäŸÑ ŸÖŸÅÿµŸÑ",
                investmentAdvice: "ŸÜÿµÿßÿ¶ÿ≠ ÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±Ÿäÿ©",
                dashboard: "ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ",
                finalAmount: "ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÜŸáÿßÿ¶Ÿä",
                totalInterest: "ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÅÿßÿ¶ÿØÿ©",
                totalContributions: "ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≥ÿßŸáŸÖÿßÿ™",
                roi: "ÿπÿßÿ¶ÿØ ÿßŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±",
                loadMore: "ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≤ŸäÿØ",
                records: "ÿ≥ÿ¨ŸÑÿßÿ™",
                portfolioDiversification: "ÿ™ŸÜŸàŸäÿπ ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ©",
                diversificationTip1: "ŸÅŸÉÿ± ŸÅŸä ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ£ŸÖŸàÿßŸÑ ÿπÿ®ÿ± ŸÅÿ¶ÿßÿ™ ÿ£ÿµŸàŸÑ ŸÖÿÆÿ™ŸÑŸÅÿ© (ÿ£ÿ≥ŸáŸÖÿå ÿ≥ŸÜÿØÿßÿ™ÿå ÿπŸÇÿßÿ±ÿßÿ™)",
                diversificationTip2: "ÿßŸÑÿ≥ŸàŸÇ ÿßŸÑÿ£ŸÖÿ±ŸäŸÉŸä: ÿ±ŸÉÿ≤ ÿπŸÑŸâ ÿµŸÜÿßÿØŸäŸÇ ŸÖÿ§ÿ¥ÿ± S&P 500 ŸÑŸÑÿ™ÿπÿ±ÿ∂ ÿßŸÑŸàÿßÿ≥ÿπ ŸÑŸÑÿ≥ŸàŸÇ",
                diversificationTip3: "ÿßŸÑÿ≥ŸàŸÇ ÿßŸÑÿ≥ÿπŸàÿØŸä: ŸÅŸÉÿ± ŸÅŸä ÿµŸÜÿßÿØŸäŸÇ Tadawul All Share Index (TASI) ÿßŸÑŸÖÿ™ÿØÿßŸàŸÑÿ©",
                diversificationTip4: "ÿßŸÑÿ≥ŸàŸÇ ÿßŸÑŸÖÿµÿ±Ÿä: ŸäŸàŸÅÿ± ŸÖÿ§ÿ¥ÿ± EGX 30 ÿ™ÿπÿ±ÿ∂Ÿãÿß ŸÑÿ£ŸÉÿ®ÿ± ÿßŸÑÿ¥ÿ±ŸÉÿßÿ™ ÿßŸÑŸÖÿµÿ±Ÿäÿ©",
                diversificationTip5: "ÿ£ÿπÿØ ŸÖŸàÿßÿ≤ŸÜÿ© ŸÖÿ≠ŸÅÿ∏ÿ™ŸÉ ÿ≥ŸÜŸàŸäŸãÿß ŸÑŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑŸÖÿ≥ÿ™ŸáÿØŸÅ",
                suggestedAllocation: "ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑŸÖŸÇÿ™ÿ±ÿ≠",
                investmentProjection: "ÿ™ŸàŸÇÿπÿßÿ™ ÿßŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ± ŸàÿßŸÑÿ™ŸÜÿ®ÿ§",
                projectionSubtitle: "ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ£ÿØÿßÿ° ÿßŸÑÿ≥ŸàŸÇ ÿßŸÑÿ™ÿßÿ±ŸäÿÆŸä ŸàÿßŸÑŸÖÿπŸÑŸÖÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ©",
                portfolioGrowth: "ŸÜŸÖŸà ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ© ÿ®ŸÖÿ±Ÿàÿ± ÿßŸÑŸàŸÇÿ™",
                annualReturns: "ÿßŸÑÿπŸàÿßÿ¶ÿØ ÿßŸÑÿ≥ŸÜŸàŸäÿ©",
                incomeSources: "ŸÖÿµÿßÿØÿ± ÿßŸÑÿØÿÆŸÑ",
                riskAnalysis: "ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖÿÆÿßÿ∑ÿ±",
                recentCalculations: "ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿßŸÑÿ£ÿÆŸäÿ±ÿ©",
                yourInvestmentActivity: "ŸÜÿ¥ÿßÿ∑ŸÉ ÿßŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±Ÿä",
                portfolioPerformance: "ÿ£ÿØÿßÿ° ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ©",
                historicalGrowthSimulation: "ŸÖÿ≠ÿßŸÉÿßÿ© ÿßŸÑŸÜŸÖŸà ÿßŸÑÿ™ÿßÿ±ŸäÿÆŸä",
                quickMetrics: "ŸÖŸÇÿßŸäŸäÿ≥ ÿ≥ÿ±Ÿäÿπÿ©",
                keyPerformanceIndicators: "ŸÖÿ§ÿ¥ÿ±ÿßÿ™ ÿßŸÑÿ£ÿØÿßÿ° ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©",
                avgAnnualReturn: "ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿπÿßÿ¶ÿØ ÿßŸÑÿ≥ŸÜŸàŸä",
                bestYear: "ÿ£ŸÅÿ∂ŸÑ ÿ≥ŸÜÿ©",
                worstYear: "ÿ£ÿ≥Ÿàÿ£ ÿ≥ŸÜÿ©",
                investmentTitle: "ÿπŸÜŸàÿßŸÜ ÿßŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±",
                initialInvestment: "ÿßŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ± ÿßŸÑÿ£ŸàŸÑŸä ($)",
                interestRate: "ŸÖÿπÿØŸÑ ÿßŸÑŸÅÿßÿ¶ÿØÿ© (%)",
                calculationFrequency: "ÿ™ÿ±ÿØÿØ ÿßŸÑÿ≠ÿ≥ÿßÿ®",
                monthlyAdd: "ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ© ($)",
                investmentPeriod: "ŸÅÿ™ÿ±ÿ© ÿßŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±",
                years: "ÿ≥ŸÜŸàÿßÿ™",
                months: "ÿ£ÿ¥Ÿáÿ±",
                days: "ÿ£ŸäÿßŸÖ",
                periodValue: "ŸÇŸäŸÖÿ© ÿßŸÑŸÅÿ™ÿ±ÿ©",
                startDate: "ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿ°",
                remove: "ÿ•ÿ≤ÿßŸÑÿ©"
            }
        };

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            document.getElementById('investment-date').value = formattedDate;
            document.getElementById('transaction-date').value = formattedDate;
            
            // Initialize event listeners
            initEventListeners();
            
            // Initialize database
            initDatabase();
            
            // Update slider value display
            updateSliderValue();
            
            // Load recent calculations
            updateRecentCalculations();
            
            // Perform initial calculation if we have investments
            if (investments.length > 0) {
                calculateInvestment();
            }
        });

        // Initialize event listeners
        function initEventListeners() {
            // Theme toggle
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            
            // Language toggle
            document.getElementById('language-toggle').addEventListener('click', toggleLanguage);
            
            // Show investment form
            document.getElementById('add-investment').addEventListener('click', function() {
                document.getElementById('investment-form-container').style.display = 'block';
                this.style.display = 'none';
            });
            
            // Cancel investment form
            document.getElementById('cancel-investment').addEventListener('click', function() {
                document.getElementById('investment-form-container').style.display = 'none';
                document.getElementById('add-investment').style.display = 'inline-flex';
            });
            
            // Save investment
            document.getElementById('save-investment').addEventListener('click', saveInvestment);
            
            // Investment rate slider
            document.getElementById('investment-rate').addEventListener('input', function() {
                document.querySelector('#investment-form-container .slider-value').textContent = `${this.value}%`;
            });
            
            // Calculate button
            document.getElementById('calculate-btn').addEventListener('click', calculateInvestment);
            
            // Add transaction button
            document.getElementById('add-transaction').addEventListener('click', addTransaction);
            
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
            
            // Load more button
            document.getElementById('load-more').addEventListener('click', function() {
                displayCount += 50;
                displayBreakdown();
            });
            
            // Data management buttons
            document.getElementById('save-data').addEventListener('click', saveData);
            document.getElementById('load-data').addEventListener('click', loadData);
            document.getElementById('export-data').addEventListener('click', exportData);
            document.getElementById('import-data').addEventListener('click', triggerImport);
            document.getElementById('import-file').addEventListener('change', importData);
            
            // How to guide
            document.getElementById('show-guide').addEventListener('click', showGuide);
            document.querySelector('.close-modal').addEventListener('click', hideGuide);
            document.getElementById('guide-modal').addEventListener('click', function(e) {
                if (e.target === this) hideGuide();
            });
        }

        // Update slider value display
        function updateSliderValue() {
            const slider = document.getElementById('investment-rate');
            const valueDisplay = document.querySelector('#investment-form-container .slider-value');
            if (slider && valueDisplay) {
                valueDisplay.textContent = `${slider.value}%`;
            }
        }

        // Toggle between light and dark themes
        function toggleTheme() {
            const themeToggle = document.getElementById('theme-toggle');
            if (currentTheme === 'light') {
                document.body.setAttribute('data-theme', 'dark');
                currentTheme = 'dark';
                themeToggle.innerHTML = '‚òÄÔ∏è <span data-translate="darkMode">Light Mode</span>';
            } else {
                document.body.removeAttribute('data-theme');
                currentTheme = 'light';
                themeToggle.innerHTML = 'üåô <span data-translate="darkMode">Dark Mode</span>';
            }
            translatePage();
        }

        // Toggle between English and Arabic
        function toggleLanguage() {
            const langToggle = document.getElementById('language-toggle');
            if (currentLanguage === 'en') {
                document.body.setAttribute('dir', 'rtl');
                currentLanguage = 'ar';
                langToggle.textContent = 'English';
            } else {
                document.body.removeAttribute('dir');
                currentLanguage = 'en';
                langToggle.textContent = 'ÿπÿ±ÿ®Ÿâ';
            }
            translatePage();
        }

        // Translate the page
        function translatePage() {
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });
        }

        // Show the how-to guide
        function showGuide() {
            document.getElementById('guide-modal').style.display = 'flex';
        }

        // Hide the how-to guide
        function hideGuide() {
            document.getElementById('guide-modal').style.display = 'none';
        }

        // Save a new investment
        function saveInvestment() {
            const name = document.getElementById('investment-name').value || `Investment ${investments.length + 1}`;
            const amount = parseFloat(document.getElementById('investment-amount').value);
            const rate = parseFloat(document.getElementById('investment-rate').value);
            const frequency = document.getElementById('investment-frequency').value;
            const monthly = parseFloat(document.getElementById('investment-monthly').value);
            const period = parseInt(document.getElementById('investment-period').value);
            const date = document.getElementById('investment-date').value;
            
            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid investment amount');
                return;
            }
            
            const id = Date.now();
            const investment = {
                id,
                name,
                amount,
                rate,
                frequency,
                monthly,
                period,
                date
            };
            
            investments.push(investment);
            renderInvestmentCards();
            updateInvestmentSelect();
            
            // Hide the form and show the add button
            document.getElementById('investment-form-container').style.display = 'none';
            document.getElementById('add-investment').style.display = 'inline-flex';
            
            // Reset form
            document.getElementById('investment-name').value = '';
        }

        // Remove an investment
        function removeInvestment(id) {
            if (confirm('Are you sure you want to remove this investment?')) {
                investments = investments.filter(inv => inv.id !== id);
                renderInvestmentCards();
                updateInvestmentSelect();
            }
        }

        // Render investment cards
        function renderInvestmentCards() {
            const container = document.getElementById('portfolio-container');
            container.innerHTML = '';
            
            if (investments.length === 0) {
                container.innerHTML = '<div class="portfolio-card"><div class="portfolio-card-header"><div class="portfolio-card-title">No Investments</div></div><div class="portfolio-card-details"><div class="portfolio-card-detail">Click "Add Investment" to get started</div></div></div>';
                return;
            }
            
            investments.forEach(investment => {
                const card = document.createElement('div');
                card.className = 'portfolio-card slide-up';
                
                // Format date for display
                const dateObj = new Date(investment.date);
                const formattedDate = dateObj.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                card.innerHTML = `
                    <div class="portfolio-card-header">
                        <div class="portfolio-card-title">${investment.name}</div>
                        <div class="investment-actions">
                            <button class="btn btn-danger btn-sm btn-icon" data-id="${investment.id}">√ó</button>
                        </div>
                    </div>
                    <div class="portfolio-card-details">
                        <div class="portfolio-card-detail">
                            <div class="portfolio-card-detail-label">Amount</div>
                            <div class="portfolio-card-detail-value">$${investment.amount.toLocaleString()}</div>
                        </div>
                        <div class="portfolio-card-detail">
                            <div class="portfolio-card-detail-label">Rate</div>
                            <div class="portfolio-card-detail-value">${investment.rate}%</div>
                        </div>
                        <div class="portfolio-card-detail">
                            <div class="portfolio-card-detail-label">Start Date</div>
                            <div class="portfolio-card-detail-value">${formattedDate}</div>
                        </div>
                        <div class="portfolio-card-detail">
                            <div class="portfolio-card-detail-label">Period</div>
                            <div class="portfolio-card-detail-value">${investment.period} years</div>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
                
                // Add event listener to delete button
                const deleteBtn = card.querySelector('.btn-danger');
                deleteBtn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    removeInvestment(id);
                });
            });
        }

        // Update investment select dropdown
        function updateInvestmentSelect() {
            const select = document.getElementById('investment-select');
            // Keep the "Entire Portfolio" option
            select.innerHTML = '<option value="all">Entire Portfolio</option>';
            
            // Add each investment as an option
            investments.forEach(investment => {
                const option = document.createElement('option');
                option.value = investment.id;
                option.textContent = investment.name;
                select.appendChild(option);
            });
        }

        // Switch between tabs
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // If switching to dashboard tab, update the charts
            if (tabName === 'dashboard') {
                updateDashboardCharts();
            }
            
            // If switching to advice tab, update the allocation chart
            if (tabName === 'advice') {
                updateAllocationChart();
                updateProjectionChart();
            }
        }

        // Add a transaction
        function addTransaction() {
            const date = document.getElementById('transaction-date').value;
            const amount = parseFloat(document.getElementById('transaction-amount').value);
            const type = document.getElementById('transaction-type').value;
            const investmentId = document.getElementById('investment-select').value;
            const recurringMonths = parseInt(document.getElementById('recurring-months').value);
            
            if (!date || isNaN(amount) || amount <= 0) {
                alert('Please enter valid transaction details.');
                return;
            }
            
            // Get investment name for display
            let investmentName = "Entire Portfolio";
            if (investmentId !== "all") {
                const investment = investments.find(inv => inv.id === parseInt(investmentId));
                investmentName = investment ? investment.name : "Unknown Investment";
            }
            
            const transaction = {
                id: Date.now(),
                date,
                amount,
                type,
                investmentId,
                investmentName,
                recurringMonths,
                createdAt: new Date().toISOString()
            };
            
            transactions.push(transaction);
            displayTransactions();
            
            // Clear the form
            document.getElementById('transaction-amount').value = '';
            document.getElementById('recurring-months').value = '0';
        }

        // Remove a transaction
        function removeTransaction(id) {
            transactions = transactions.filter(t => t.id !== id);
            displayTransactions();
        }

        // Display transactions
        function displayTransactions() {
            const container = document.getElementById('transactions-container');
            container.innerHTML = '';
            
            if (transactions.length === 0) {
                container.innerHTML = '<div class="transaction-item">No transactions added yet</div>';
                return;
            }
            
            // Sort transactions by date (newest first)
            const sortedTransactions = [...transactions].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );
            
            sortedTransactions.forEach(transaction => {
                const div = document.createElement('div');
                div.className = 'transaction-item';
                
                const date = new Date(transaction.date).toLocaleDateString();
                const sign = transaction.type === 'deposit' ? '+' : '-';
                const amountClass = transaction.type === 'deposit' ? 'positive' : 'negative';
                const recurringText = transaction.recurringMonths > 0 
                    ? `Recurring (${transaction.recurringMonths} months)` 
                    : 'One-time';
                
                div.innerHTML = `
                    <div class="transaction-details">
                        <div class="transaction-date">${date}</div>
                        <div>${recurringText} ${transaction.type} to ${transaction.investmentName}</div>
                    </div>
                    <div class="transaction-amount ${amountClass}">${sign}$${transaction.amount.toFixed(2)}</div>
                    <div class="transaction-actions">
                        <button class="btn-outline btn-sm" data-id="${transaction.id}">Remove</button>
                    </div>
                `;
                
                container.appendChild(div);
                
                // Add event listener to remove button
                const removeBtn = div.querySelector('.btn-outline');
                removeBtn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    removeTransaction(id);
                });
            });
        }

        // Calculate investment growth for the entire portfolio
        function calculateInvestment() {
            if (investments.length === 0) {
                alert('Please add at least one investment');
                return;
            }
            
            let totalFinalAmount = 0;
            let totalContributions = 0;
            let totalInterest = 0;
            let allBreakdownData = [];
            
            // Calculate each investment
            investments.forEach(investment => {
                const result = calculateSingleInvestment(investment);
                totalFinalAmount += result.finalAmount;
                totalContributions += result.totalContributions;
                totalInterest += result.totalInterest;
                allBreakdownData = allBreakdownData.concat(result.breakdownData);
            });
            
            // Apply transactions to the portfolio
            const transactionResults = applyTransactionsToPortfolio(totalFinalAmount, allBreakdownData);
            totalFinalAmount = transactionResults.finalAmount;
            allBreakdownData = transactionResults.breakdownData;
            
            // Calculate ROI
            const roi = totalContributions > 0 ? ((totalFinalAmount - totalContributions) / totalContributions) * 100 : 0;
            
            // Update result display
            document.getElementById('final-amount').textContent = `$${totalFinalAmount.toFixed(2)}`;
            document.getElementById('total-interest').textContent = `$${totalInterest.toFixed(2)}`;
            document.getElementById('total-contributions').textContent = `$${totalContributions.toFixed(2)}`;
            document.getElementById('roi').textContent = `${roi.toFixed(2)}%`;
            
            // Store breakdown data
            breakdownData = allBreakdownData;
            
            // Display breakdown
            displayBreakdown();
            
            // Update charts
            updateSummaryChart(totalContributions, totalInterest);
            updatePerformanceChart(breakdownData);
            updateDashboardCharts();
            updateProjectionChart();
            
            // Save recent calculation
            saveRecentCalculation({
                investments: [...investments],
                transactions: [...transactions],
                finalAmount: totalFinalAmount,
                totalInterest,
                totalContributions,
                roi,
                createdAt: new Date().toISOString()
            });
        }

        // Calculate a single investment
        function calculateSingleInvestment(investment) {
            const initialAmount = investment.amount;
            const interestRate = investment.rate / 100;
            const frequency = investment.frequency;
            const monthlyAdd = investment.monthly;
            const periodValue = investment.period;
            const startDate = new Date(investment.date);
            
            // Calculate total days based on period type (always years in this implementation)
            const endDate = new Date(startDate);
            endDate.setFullYear(endDate.getFullYear() + periodValue);
            const totalDays = periodValue * 365;
            
            // Calculate compounding periods
            let periodsPerYear = 1;
            switch (frequency) {
                case 'monthly':
                    periodsPerYear = 12;
                    break;
                case 'quarterly':
                    periodsPerYear = 4;
                    break;
                case 'annually':
                    periodsPerYear = 1;
                    break;
            }
            
            // Calculate effective interest rate per period
            const ratePerPeriod = interestRate / periodsPerYear;
            
            // Initialize variables for calculation
            let currentAmount = initialAmount;
            let totalContributions = initialAmount;
            let totalInterest = 0;
            
            // Prepare breakdown data
            const breakdownData = [];
            const monthlyData = [];
            
            // Add initial state
            breakdownData.push({
                date: new Date(startDate),
                amount: currentAmount,
                contribution: initialAmount,
                interest: 0,
                type: 'initial',
                investmentId: investment.id,
                investmentName: investment.name
            });
            
            monthlyData.push({
                date: new Date(startDate),
                amount: currentAmount
            });
            
            // Calculate for each period
            const currentDate = new Date(startDate);
            let monthCounter = 0;
            
            while (currentDate < endDate) {
                // Add monthly contribution at the beginning of each month (except the first)
                if (monthCounter > 0 && currentDate.getDate() === 1) {
                    currentAmount += monthlyAdd;
                    totalContributions += monthlyAdd;
                    
                    breakdownData.push({
                        date: new Date(currentDate),
                        amount: currentAmount,
                        contribution: monthlyAdd,
                        interest: 0,
                        type: 'monthly',
                        investmentId: investment.id,
                        investmentName: investment.name
                    });
                }
                
                // Calculate interest for the period
                let periodInterest = 0;
                
                // Different calculation based on frequency
                if (frequency === 'monthly' && currentDate.getDate() === 1) {
                    periodInterest = currentAmount * ratePerPeriod;
                } else if (frequency === 'quarterly' && 
                          currentDate.getDate() === 1 && 
                          (currentDate.getMonth() === 0 || 
                           currentDate.getMonth() === 3 || 
                           currentDate.getMonth() === 6 || 
                           currentDate.getMonth() === 9)) {
                    periodInterest = currentAmount * ratePerPeriod;
                } else if (frequency === 'annually' && 
                          currentDate.getDate() === 1 && 
                          currentDate.getMonth() === 0) {
                    periodInterest = currentAmount * ratePerPeriod;
                }
                
                if (periodInterest > 0) {
                    currentAmount += periodInterest;
                    totalInterest += periodInterest;
                    
                    breakdownData.push({
                        date: new Date(currentDate),
                        amount: currentAmount,
                        contribution: 0,
                        interest: periodInterest,
                        type: 'interest',
                        investmentId: investment.id,
                        investmentName: investment.name
                    });
                }
                
                // Advance to next day
                currentDate.setDate(currentDate.getDate() + 1);
                
                // Count months for monthly contributions
                if (currentDate.getDate() === 1) {
                    monthCounter++;
                }
                
                // Record monthly data for chart
                if (currentDate.getDate() === 1) {
                    monthlyData.push({
                        date: new Date(currentDate),
                        amount: currentAmount
                    });
                }
            }
            
            return {
                finalAmount: currentAmount,
                totalContributions,
                totalInterest,
                breakdownData
            };
        }

        // Apply transactions to the portfolio
        function applyTransactionsToPortfolio(initialAmount, breakdownData) {
            let currentAmount = initialAmount;
            const updatedBreakdownData = [...breakdownData];
            
            transactions.forEach(transaction => {
                const transactionDate = new Date(transaction.date);
                const isRecurring = transaction.recurringMonths > 0;
                
                // Apply to specific investment or entire portfolio
                if (transaction.investmentId === 'all') {
                    // Apply to entire portfolio
                    if (transaction.type === 'deposit') {
                        currentAmount += transaction.amount;
                        
                        // Add transaction to breakdown
                        updatedBreakdownData.push({
                            date: transactionDate,
                            amount: currentAmount,
                            contribution: transaction.amount,
                            interest: 0,
                            type: 'deposit',
                            investmentId: 'portfolio',
                            investmentName: 'Entire Portfolio'
                        });
                    } else {
                        currentAmount -= transaction.amount;
                        
                        // Add transaction to breakdown
                        updatedBreakdownData.push({
                            date: transactionDate,
                            amount: currentAmount,
                            contribution: -transaction.amount,
                            interest: 0,
                            type: 'withdrawal',
                            investmentId: 'portfolio',
                            investmentName: 'Entire Portfolio'
                        });
                    }
                } else {
                    // Apply to specific investment
                    // This would require more complex logic to track individual investments
                    // For simplicity, we'll just add it to the portfolio total
                    if (transaction.type === 'deposit') {
                        currentAmount += transaction.amount;
                        
                        // Add transaction to breakdown
                        updatedBreakdownData.push({
                            date: transactionDate,
                            amount: currentAmount,
                            contribution: transaction.amount,
                            interest: 0,
                            type: 'deposit',
                            investmentId: transaction.investmentId,
                            investmentName: transaction.investmentName
                        });
                    } else {
                        currentAmount -= transaction.amount;
                        
                        // Add transaction to breakdown
                        updatedBreakdownData.push({
                            date: transactionDate,
                            amount: currentAmount,
                            contribution: -transaction.amount,
                            interest: 0,
                            type: 'withdrawal',
                            investmentId: transaction.investmentId,
                            investmentName: transaction.investmentName
                        });
                    }
                }
            });
            
            // Sort breakdown data by date
            updatedBreakdownData.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            return {
                finalAmount: currentAmount,
                breakdownData: updatedBreakdownData
            };
        }

        // Display breakdown data
        function displayBreakdown() {
            const container = document.getElementById('breakdown-container');
            container.innerHTML = '';
            
            // Sort breakdown data by date
            breakdownData.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Display only a subset of data (for performance)
            const displayData = breakdownData.slice(0, displayCount);
            
            if (displayData.length === 0) {
                container.innerHTML = '<div class="transaction-item">No data to display</div>';
                return;
            }
            
            displayData.forEach(item => {
                const div = document.createElement('div');
                div.className = 'transaction-item fade-in';
                
                const dateStr = new Date(item.date).toLocaleDateString();
                let description = '';
                let amount = '';
                
                switch (item.type) {
                    case 'initial':
                        description = `Initial investment (${item.investmentName})`;
                        amount = `$${item.contribution.toFixed(2)}`;
                        break;
                    case 'monthly':
                        description = `Monthly contribution (${item.investmentName})`;
                        amount = `<span class="positive">+$${item.contribution.toFixed(2)}</span>`;
                        break;
                    case 'deposit':
                        description = `Deposit to ${item.investmentName}`;
                        amount = `<span class="positive">+$${item.contribution.toFixed(2)}</span>`;
                        break;
                    case 'withdrawal':
                        description = `Withdrawal from ${item.investmentName}`;
                        amount = `<span class="negative">-$${Math.abs(item.contribution).toFixed(2)}</span>`;
                        break;
                    case 'interest':
                        description = `Interest earned (${item.investmentName})`;
                        amount = `<span class="positive">+$${item.interest.toFixed(2)}</span>`;
                        break;
                }
                
                div.innerHTML = `
                    <div class="transaction-details">
                        <div class="transaction-date">${dateStr}</div>
                        <div>${description}</div>
                    </div>
                    <div>${amount}</div>
                    <div><strong>$${item.amount.toFixed(2)}</strong></div>
                `;
                
                container.appendChild(div);
            });
            
            // Show or hide load more button
            const loadMoreBtn = document.getElementById('load-more');
            if (breakdownData.length > displayCount) {
                loadMoreBtn.style.display = 'block';
                loadMoreBtn.innerHTML = `<span data-translate="loadMore">Load More</span> (${Math.min(50, breakdownData.length - displayCount)} <span data-translate="records">records</span>)`;
                translateElement(loadMoreBtn);
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }

        // Translate a single element
        function translateElement(element) {
            element.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (translations[currentLanguage][key]) {
                    el.textContent = translations[currentLanguage][key];
                }
            });
        }

        // Update summary chart
        function updateSummaryChart(contributions, interest) {
            const ctx = document.getElementById('summary-chart').getContext('2d');
            
            if (window.summaryChart) {
                window.summaryChart.destroy();
            }
            
            window.summaryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Contributions', 'Interest Earned'],
                    datasets: [{
                        data: [contributions, interest],
                        backgroundColor: [
                            '#4A7B9D',
                            '#34A853'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Update performance chart
        function updatePerformanceChart(data) {
            const ctx = document.getElementById('performance-chart').getContext('2d');
            
            if (window.performanceChart) {
                window.performanceChart.destroy();
            }
            
            // Group data by month for better visualization
            const monthlyData = {};
            data.forEach(item => {
                const date = new Date(item.date);
                const monthYear = `${date.getFullYear()}-${date.getMonth() + 1}`;
                
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = {
                        date: new Date(date.getFullYear(), date.getMonth(), 1),
                        amount: item.amount
                    };
                } else {
                    monthlyData[monthYear].amount = item.amount;
                }
            });
            
            const sortedData = Object.values(monthlyData).sort((a, b) => a.date - b.date);
            
            window.performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedData.map(d => d.date.toLocaleDateString(undefined, { month: 'short', year: 'numeric' })),
                    datasets: [{
                        label: 'Portfolio Value',
                        data: sortedData.map(d => d.amount),
                        borderColor: '#6C3F49',
                        backgroundColor: 'rgba(108, 63, 73, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update dashboard charts
        function updateDashboardCharts() {
            updateGrowthChart();
            updateReturnsChart();
            updateIncomeChart();
            updateRiskChart();
            updateQuickMetrics();
        }

        // Update growth chart
        function updateGrowthChart() {
            const ctx = document.getElementById('growth-chart').getContext('2d');
            
            if (window.growthChart) {
                window.growthChart.destroy();
            }
            
            // Group data by year for growth chart
            const yearlyData = {};
            breakdownData.forEach(item => {
                const date = new Date(item.date);
                const year = date.getFullYear();
                
                if (!yearlyData[year]) {
                    yearlyData[year] = {
                        date: new Date(year, 0, 1),
                        amount: item.amount
                    };
                } else {
                    yearlyData[year].amount = item.amount;
                }
            });
            
            const sortedData = Object.values(yearlyData).sort((a, b) => a.date - b.date);
            
            window.growthChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedData.map(d => d.date.getFullYear()),
                    datasets: [{
                        label: 'Portfolio Value',
                        data: sortedData.map(d => d.amount),
                        backgroundColor: '#4A7B9D',
                        borderColor: '#4A7B9D',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update returns chart
        function updateReturnsChart() {
            const ctx = document.getElementById('returns-chart').getContext('2d');
            
            if (window.returnsChart) {
                window.returnsChart.destroy();
            }
            
            // Calculate annual returns
            const yearlyReturns = {};
            for (let i = 1; i < breakdownData.length; i++) {
                const current = breakdownData[i];
                const previous = breakdownData[i - 1];
                
                const currentDate = new Date(current.date);
                const previousDate = new Date(previous.date);
                
                if (currentDate.getFullYear() !== previousDate.getFullYear()) {
                    const returnValue = ((current.amount - previous.amount) / previous.amount) * 100;
                    const year = currentDate.getFullYear();
                    
                    if (!yearlyReturns[year]) {
                        yearlyReturns[year] = returnValue;
                    }
                }
            }
            
            const years = Object.keys(yearlyReturns).sort();
            const returns = years.map(year => yearlyReturns[year]);
            
            window.returnsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Annual Return (%)',
                        data: returns,
                        borderColor: '#34A853',
                        backgroundColor: 'rgba(52, 168, 83, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update income chart
        function updateIncomeChart() {
            const ctx = document.getElementById('income-chart').getContext('2d');
            
            if (window.incomeChart) {
                window.incomeChart.destroy();
            }
            
            // Calculate income from different sources
            let interestIncome = 0;
            let contributionIncome = 0;
            
            breakdownData.forEach(item => {
                if (item.type === 'interest') {
                    interestIncome += item.interest;
                } else if (item.type === 'monthly' || item.type === 'deposit' || item.type === 'initial') {
                    contributionIncome += item.contribution;
                }
            });
            
            window.incomeChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Interest Income', 'Contributions'],
                    datasets: [{
                        data: [interestIncome, contributionIncome],
                        backgroundColor: [
                            '#34A853',
                            '#4A7B9D'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Update risk chart
        function updateRiskChart() {
            const ctx = document.getElementById('risk-chart').getContext('2d');
            
            if (window.riskChart) {
                window.riskChart.destroy();
            }
            
            // Simulate risk analysis (this would normally come from more complex calculations)
            window.riskChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Market Risk', 'Inflation Risk', 'Liquidity Risk', 'Concentration Risk', 'Interest Rate Risk'],
                    datasets: [{
                        label: 'Risk Profile',
                        data: [65, 40, 75, 30, 55],
                        backgroundColor: 'rgba(108, 63, 73, 0.2)',
                        borderColor: '#6C3F49',
                        pointBackgroundColor: '#6C3F49',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#6C3F49'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: {
                                display: true
                            },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    }
                }
            });
        }

        // Update quick metrics
        function updateQuickMetrics() {
            // Calculate average annual return
            let totalReturn = 0;
            let returnCount = 0;
            
            for (let i = 1; i < breakdownData.length; i++) {
                const current = breakdownData[i];
                const previous = breakdownData[i - 1];
                
                const currentDate = new Date(current.date);
                const previousDate = new Date(previous.date);
                
                if (currentDate.getFullYear() !== previousDate.getFullYear()) {
                    const returnValue = ((current.amount - previous.amount) / previous.amount) * 100;
                    totalReturn += returnValue;
                    returnCount++;
                }
            }
            
            const avgReturn = returnCount > 0 ? totalReturn / returnCount : 0;
            
            // Find best and worst years (simplified)
            let bestYear = 0;
            let worstYear = 0;
            
            for (let i = 1; i < breakdownData.length; i++) {
                const current = breakdownData[i];
                const previous = breakdownData[i - 1];
                
                const currentDate = new Date(current.date);
                const previousDate = new Date(previous.date);
                
                if (currentDate.getFullYear() !== previousDate.getFullYear()) {
                    const returnValue = ((current.amount - previous.amount) / previous.amount) * 100;
                    
                    if (returnValue > bestYear) bestYear = returnValue;
                    if (returnValue < worstYear) worstYear = returnValue;
                }
            }
            
            document.getElementById('avg-return').textContent = `${avgReturn.toFixed(2)}%`;
            document.getElementById('best-year').textContent = `${bestYear.toFixed(2)}%`;
            document.getElementById('worst-year').textContent = `${worstYear.toFixed(2)}%`;
        }

        // Update projection chart
        function updateProjectionChart() {
            const ctx = document.getElementById('projection-chart').getContext('2d');
            
            if (window.projectionChart) {
                window.projectionChart.destroy();
            }
            
            // Generate projection data based on different scenarios
            const scenarios = [
                { label: 'Optimistic (10% growth)', color: '#34A853', multiplier: 1.1 },
                { label: 'Expected (7% growth)', color: '#4A7B9D', multiplier: 1.07 },
                { label: 'Conservative (4% growth)', color: '#6C3F49', multiplier: 1.04 }
            ];
            
            const initialAmount = investments.reduce((sum, inv) => sum + inv.amount, 0);
            const monthlyAdd = investments.reduce((sum, inv) => sum + inv.monthly, 0);
            const periodValue = Math.max(...investments.map(inv => inv.period));
            
            const datasets = scenarios.map(scenario => {
                const data = [];
                let currentAmount = initialAmount;
                
                for (let i = 0; i <= periodValue; i++) {
                    data.push(currentAmount);
                    // Apply annual growth and monthly contributions
                    currentAmount = (currentAmount + monthlyAdd * 12) * scenario.multiplier;
                }
                
                return {
                    label: scenario.label,
                    data: data,
                    borderColor: scenario.color,
                    backgroundColor: 'transparent',
                    tension: 0.1
                };
            });
            
            window.projectionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: periodValue + 1}, (_, i) => `Year ${i}`),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update allocation chart
        function updateAllocationChart() {
            const ctx = document.getElementById('allocation-chart').getContext('2d');
            
            if (window.allocationChart) {
                window.allocationChart.destroy();
            }
            
            window.allocationChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['US Stocks', 'Saudi Stocks', 'Egypt Stocks', 'Bonds', 'Real Estate', 'Cash'],
                    datasets: [{
                        data: [40, 20, 10, 15, 10, 5],
                        backgroundColor: [
                            '#6C3F49',
                            '#4A7B9D',
                            '#34A853',
                            '#FBBC05',
                            '#EA4335',
                            '#CCBEBF'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Initialize IndexedDB
        function initDatabase() {
            db = localforage.createInstance({
                name: 'investment_calculator'
            });
            
            // Load saved data
            loadData();
        }

        // Save data to IndexedDB
        function saveData() {
            const data = {
                investments,
                transactions,
                calculatorSettings: {
                    // Add any other settings you want to save
                }
            };
            
            db.setItem('savedData', data)
                .then(() => {
                    alert('Data saved successfully!');
                })
                .catch(err => {
                    console.error('Error saving data:', err);
                    alert('Error saving data. Please try again.');
                });
        }

        // Load data from IndexedDB
        function loadData() {
            db.getItem('savedData')
                .then(data => {
                    if (data) {
                        // Load investments
                        if (data.investments) {
                            investments = data.investments;
                            renderInvestmentCards();
                            updateInvestmentSelect();
                        }
                        
                        // Load transactions
                        if (data.transactions) {
                            transactions = data.transactions;
                            displayTransactions();
                        }
                        
                        alert('Data loaded successfully!');
                    } else {
                        // Add sample data if no saved data exists
                        renderInvestmentCards();
                    }
                })
                .catch(err => {
                    console.error('Error loading data:', err);
                    alert('Error loading data. Please try again.');
                    renderInvestmentCards();
                });
        }

        // Export data as JSON
        function exportData() {
            const data = {
                investments,
                transactions,
                calculatorSettings: {
                    // Add any other settings you want to export
                }
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'investment_data.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Trigger import file selection
        function triggerImport() {
            document.getElementById('import-file').click();
        }

        // Import data from JSON file
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Load investments
                    if (data.investments) {
                        investments = data.investments;
                        renderInvestmentCards();
                        updateInvestmentSelect();
                    }
                    
                    // Load transactions
                    if (data.transactions) {
                        transactions = data.transactions;
                        displayTransactions();
                    }
                    
                    alert('Data imported successfully!');
                } catch (err) {
                    console.error('Error parsing JSON:', err);
                    alert('Error importing data. The file may be invalid.');
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // Save recent calculation
        function saveRecentCalculation(calculation) {
            db.getItem('recentCalculations')
                .then(calculations => {
                    calculations = calculations || [];
                    calculations.unshift(calculation);
                    
                    // Keep only the last 5 calculations
                    if (calculations.length > 5) {
                        calculations = calculations.slice(0, 5);
                    }
                    
                    recentCalculations = calculations;
                    return db.setItem('recentCalculations', calculations);
                })
                .then(() => {
                    updateRecentCalculations();
                })
                .catch(err => {
                    console.error('Error saving recent calculation:', err);
                });
        }

        // Update recent calculations display
        function updateRecentCalculations() {
            db.getItem('recentCalculations')
                .then(calculations => {
                    recentCalculations = calculations || [];
                    const container = document.getElementById('recent-transactions');
                    container.innerHTML = '';
                    
                    if (recentCalculations.length === 0) {
                        container.innerHTML = '<div class="transaction-item">No recent calculations</div>';
                        return;
                    }
                    
                    recentCalculations.forEach((calc, index) => {
                        const div = document.createElement('div');
                        div.className = 'transaction-item';
                        
                        const date = new Date(calc.createdAt).toLocaleDateString();
                        const roi = calc.roi ? calc.roi.toFixed(2) + '%' : 'N/A';
                        
                        div.innerHTML = `
                            <div class="transaction-details">
                                <div class="transaction-date">${date}</div>
                                <div>${calc.investments.length} investments ‚Ä¢ ROI: ${roi}</div>
                            </div>
                            <div class="transaction-amount positive">$${calc.finalAmount ? calc.finalAmount.toFixed(2) : '0.00'}</div>
                            <div class="transaction-actions">
                                <button class="btn-outline btn-sm" data-index="${index}" data-action="load">Load</button>
                                <button class="btn-outline btn-sm" data-index="${index}" data-action="delete">Delete</button>
                            </div>
                        `;
                        
                        container.appendChild(div);
                    });
                    
                    // Add event listeners to load and delete buttons
                    document.querySelectorAll('#recent-transactions .btn-outline').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const index = parseInt(this.getAttribute('data-index'));
                            const action = this.getAttribute('data-action');
                            
                            if (action === 'load') {
                                loadCalculation(index);
                            } else if (action === 'delete') {
                                deleteCalculation(index);
                            }
                        });
                    });
                })
                .catch(err => {
                    console.error('Error loading recent calculations:', err);
                });
        }

        // Load a specific calculation
        function loadCalculation(index) {
            const calc = recentCalculations[index];
            
            if (!calc) return;
            
            // Load investments
            if (calc.investments) {
                investments = calc.investments;
                renderInvestmentCards();
                updateInvestmentSelect();
            }
            
            // Load transactions
            if (calc.transactions) {
                transactions = calc.transactions;
                displayTransactions();
            }
            
            calculateInvestment();
            
            alert('Calculation loaded successfully!');
        }

        // Delete a specific calculation
        function deleteCalculation(index) {
            if (confirm('Are you sure you want to delete this calculation?')) {
                recentCalculations.splice(index, 1);
                
                db.setItem('recentCalculations', recentCalculations)
                    .then(() => {
                        updateRecentCalculations();
                        alert('Calculation deleted successfully!');
                    })
                    .catch(err => {
                        console.error('Error deleting calculation:', err);
                        alert('Error deleting calculation. Please try again.');
                    });
            }
        }
    </script>
</body>
</html>
